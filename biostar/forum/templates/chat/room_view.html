{% load humanize %}
{% load forum_tags %}

<div class="ui segment" style="background-color: #f6f6f6">

    <b>{{ room.name }}
        <a style="float: right"><i class="user plus icon"></i>ADD</a>
    </b>

    <div id="chat-log" class="ui blue segment" style="width: 100%; height: 300px; overflow-y: auto;background-color: #fcfcfc;">

        {% for message in messages %}
            {% chat_message message=message %}
        {% endfor %}

    </div>

    <div class="ui action input">
        <input id="chat-message-input" style="width: 10%;" type="text" size="100"/>
        <button id="chat-message-submit" type="button" value="Send" class="ui button">Send</button>
    </div>
</div>


<script>
    var roomName = "{{ room_name_json }}";

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        //let value = $('#chat-log').val();
        //let new_message = message + '<br>';
        $('#chat-log').append(message);

        $('#chat-log').animate({scrollTop: $('#chat-log').prop("scrollHeight")}, 500)
        //let obj = document.getElementById("#chat-log");
        //obj.scrollTop = obj.scrollHeight - obj.clientHeight;
        //alert(value);
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));

        messageInputDom.value = '';
    };
</script>
